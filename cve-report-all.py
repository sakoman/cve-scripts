#! /usr/bin/env python3

import os, sys

def parse(filename):
    data = {}
    for line in open(filename):
        line = line.strip()
        if line:
            if line.startswith('CVE:') or line.startswith('CVE STATUS:') or line.startswith('PACKAGE NAME:'):
                key, value = line.split(":", 1)
                data[key] = value.strip()
        else:
            yield data
            data = {}
    if data:
        yield data

cves = dict()

cvedir = sys.argv[1]
for entry in sorted(os.scandir(cvedir), key=lambda e: e.name):
    if entry.is_file() and not entry.path.endswith(".json"):
        for d in parse(entry.path):
            if d.get("CVE STATUS") == "Unpatched":
               package = str(d.get("PACKAGE NAME"))
               if d.get("CVE") in cves:
                   cves[d.get("CVE")] += ":" + package
               else:
                   cves[d.get("CVE")] = package

print("Found %d unpatched CVEs" % len(cves))
for cve in sorted(cves.keys()):
    print("%s: %s https://web.nvd.nist.gov/view/vuln/detail?vulnId=%s *" % (cve, cves[cve], cve))
